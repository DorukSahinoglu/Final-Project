import random
import math
from typing import List, Tuple

Chromosome = List[int]
Route = List[int]

DEPOT = 0
TAXI_CAPACITY = 4
FIXED_TAXI_COST = 45
COST_PER_KM = 32

def route_distance(route: Route, dist: List[List[float]]) -> float:
    if not route:
        return 0.0
    
    total = dist[DEPOT][route[0]]
    for i in range(len(route) - 1):
        total += dist[route[i]][route[i + 1]]
    
    
    return total

def route_duration(route: Route, time: List[List[float]]) -> float:
    if not route:
        return 0.0
    
    total = time[DEPOT][route[0]]
    for i in range(len(route) - 1):
        total += time[route[i]][route[i + 1]]
    
    
    return total

def random_giant_tour(n_customers: int, rng: random.Random) -> Chromosome:
    tour = list(range(1, n_customers + 1))
    rng.shuffle(tour)
    return tour

class Individual:
    def __init__(self, chromosome: Chromosome):
        self.chromosome = chromosome[:]

        self.f1_total_cost: float = float("inf")
        self.f2_max_route_duration: float = float("inf")
        self.f3_avg_route_duration: float = float("inf")

        self.rank: int = 10**9
        self.crowding: float = 0.0

        self.domination_set: List["Individual"] = []
        self.domination_count: int = 0


def init_population(pop_size: int, n_customers: int, seed: int = 46) -> List[Individual]:

    rng = random.Random(seed)
    pop: List[Individual] = []
    for _ in range(pop_size):
        chrom = random_giant_tour(n_customers, rng)
        pop.append(Individual(chrom))
    
    return pop


def ox_crossover(p1: Chromosome, p2: Chromosome, rng: random.Random) -> Tuple[Chromosome, Chromosome]:

    n = len(p1)
    assert n == len(p2)

    a, b = sorted(rng.sample(range(n), 2))

    def make_child(parent_a: Chromosome, parent_b: Chromosome) -> Chromosome:

        child = [-1] * n
        child[a:b + 1] = parent_a[a:b + 1]
        used = set(child[a:b + 1])

        idx = (b + 1) % n
        for gene in parent_b:
            if gene in used:
                continue

            child[idx] = gene
            idx = (idx + 1) % n
        
        return child
    c1 = make_child(p1, p2)
    c2 = make_child(p2, p1)

    return c1, c2

def swap_mutation(ch: Chromosome, rng: random.Random) -> Chromosome:

    n = len(ch)
    i, j = rng.sample(range(n), 2)
    out = ch[:]
    out[i], out[j] = out[j], out[i]

    return out

def inversion_mutation(ch: Chromosome, rng: random.Random) -> Chromosome:

    n = len(ch)
    i, j = sorted(rng.sample(range(n), 2))
    out = ch[:]
    out[i:j + 1] = reversed(out[i:j + 1])
    return out


def make_offspring(
        parents: List[Individual],
        rng: random.Random,
        crossover_rate: float = 0.9,
        mutation_rate: float = 0.02,
        mutation_kind: str = "swap" 
) -> List[Individual]:
    
    offspring: List[Individual] = []
    n = len(parents)

    def mutate(ch: Chromosome) -> Chromosome:

        if mutation_kind == "inversion":
            return inversion_mutation(ch, rng)
        return swap_mutation(ch, rng)
    
    i = 0
    while len(offspring) < n:
        p1 = parents[i % n].chromosome
        p2 = parents[(i + 1) % n].chromosome

        i += 2

        if rng.random() < crossover_rate:

            c1, c2 = ox_crossover(p1, p2, rng)
        else: c1, c2 = p1[:], p2[:]

        if rng.random() < mutation_rate:
            c1 = mutate(c1)
        
        if rng.random() < mutation_rate:
            c2 = mutate(c2)

        offspring.append(Individual(c1))
        if len(offspring) < n:

            offspring.append(Individual(c2))
    
    return offspring


def dominates(a: "Individual", b: "Individual") -> bool:

    a_vals = (a.f1_total_cost, a.f2_max_route_duration, a.f3_avg_route_duration)
    b_vals = (b.f1_total_cost, b.f2_max_route_duration, b.f3_avg_route_duration)

    no_worse_all = True
    better_at_least_one = False

    for av, bv in zip(a_vals, b_vals):
        if av > bv:
            no_worse_all = False
            break

        if av < bv:
            better_at_least_one = True

    return no_worse_all and better_at_least_one

def fast_non_dominated_sort(population: List["Individual"]) -> List[List["Individual"]]:
    
    for p in population:
        p.domination_set = []
        p.domination_count = 0
        p.rank = 10**9

    fronts: List[List[Individual]] = []
    F1: List[Individual] = []

    
    for i, p in enumerate(population):
        for j in range(i + 1, len(population)):
            q = population[j]
            if dominates(p, q):
                p.domination_set.append(q)
                q.domination_count += 1
            elif dominates(q, p):
                q.domination_set.append(p)
                p.domination_count += 1

    
    for p in population:
        if p.domination_count == 0:
            p.rank = 1
            F1.append(p)

    fronts.append(F1)

    
    k = 0
    while k < len(fronts) and fronts[k]:
        next_front: List[Individual] = []
        for p in fronts[k]:
            for q in p.domination_set:
                q.domination_count -= 1
                if q.domination_count == 0:
                    q.rank = k + 2
                    next_front.append(q)
        k += 1
        if next_front:
            fronts.append(next_front)

    return fronts

def assign_crowding_distance(front: List["Individual"]) -> None:
  
    if not front:
        return

    for ind in front:
        ind.crowding = 0.0

   
    objectives = [
        ("f1_total_cost",),
        ("f2_max_route_duration",),
        ("f3_avg_route_duration",),
    ]

    m = len(objectives)
    n = len(front)
    if n <= 2:
        
        for ind in front:
            ind.crowding = float("inf")
        return

    for (attr,) in objectives:
        front.sort(key=lambda x: getattr(x, attr))

        
        front[0].crowding = float("inf")
        front[-1].crowding = float("inf")

        f_min = getattr(front[0], attr)
        f_max = getattr(front[-1], attr)
        denom = f_max - f_min

        if denom <= 1e-12:
            
            continue

       
        for i in range(1, n - 1):
            prev_v = getattr(front[i - 1], attr)
            next_v = getattr(front[i + 1], attr)
            front[i].crowding += (next_v - prev_v) / denom


def environmental_selection_elitist(
    parents: List["Individual"],
    offspring: List["Individual"],
    pop_size: int
) -> List["Individual"]:
   
    R = parents + offspring

    fronts = fast_non_dominated_sort(R)

    next_pop: List[Individual] = []
    for front in fronts:
        assign_crowding_distance(front)

        if len(next_pop) + len(front) <= pop_size:
            next_pop.extend(front)
        else:
            
            remaining = pop_size - len(next_pop)
            front.sort(key=lambda x: x.crowding, reverse=True)
            next_pop.extend(front[:remaining])
            break

    return next_pop

def tournament_pick(population: List["Individual"], rng: random.Random, k: int = 2) -> "Individual":

    contestants = rng.sample(population, k)
    best = contestants[0]
    for c in contestants[1:]:
        if c.rank < best.rank:
            best = c
        elif c.rank == best.rank and c.crowding > best.crowding:
            best = c
    return best


def build_mating_pool(population: List["Individual"], pool_size: int, seed: int = 123) -> List["Individual"]:
   
    rng = random.Random(seed)
    mating_pool: List[Individual] = []
    for _ in range(pool_size):
        mating_pool.append(tournament_pick(population, rng, k=2))
    return mating_pool
def apply_duplicate_penalty(pop: List["Individual"], penalty_step: float = 10.0) -> None:
   
    buckets = {}
    for ind in pop:
        key = tuple(ind.chromosome)
        buckets.setdefault(key, []).append(ind)

    for key, inds in buckets.items():
        if len(inds) <= 1:
            continue
       
        for k, ind in enumerate(inds):
            if k == 0:
                continue
            ind.f1_total_cost += k * penalty_step


def evaluate_stub(ind: "Individual", rng: random.Random) -> None:
   
    ind.f1_total_cost = rng.uniform(1000, 3000)
    ind.f2_max_route_duration = rng.uniform(50, 200)
    ind.f3_avg_route_duration = rng.uniform(30, 150)


def evaluate_population_stub(pop: List["Individual"], seed: int = 999) -> None:
    rng = random.Random(seed)
    for ind in pop:
        evaluate_stub(ind, rng)


def prepare_rank_and_crowding(population: List["Individual"]) -> None:
   
    fronts = fast_non_dominated_sort(population)
    for front in fronts:
        assign_crowding_distance(front)


def nsga2_main_stub(
    n_customers: int,
    pop_size: int = 60,
    generations: int = 100,
    seed: int = 42,
    crossover_rate: float = 0.9,
    mutation_rate: float = 0.2,
    mutation_kind: str = "inversion",
) -> List["Individual"]:

    rng = random.Random(seed)

  
    P = init_population(pop_size, n_customers, seed=seed)

   
    evaluate_population_stub(P, seed=seed + 1000)

    for gen in range(generations):
       
        prepare_rank_and_crowding(P)

        #
        mating_pool = build_mating_pool(P, pool_size=pop_size, seed=seed + 2000 + gen)

        
        Q = make_offspring(
            parents=mating_pool,
            rng=rng,
            crossover_rate=crossover_rate,
            mutation_rate=mutation_rate,
            mutation_kind=mutation_kind
        )

        
        evaluate_population_stub(Q, seed=seed + 3000 + gen)

        
        P = environmental_selection_elitist(P, Q, pop_size)

        if (gen + 1) % 10 == 0:
            
            best_rank1 = sum(1 for x in P if x.rank == 1)
            print(f"Gen {gen+1:4d} | rank1 count: {best_rank1}")

    return P


def segment_route_cost(route: List[int], dist: List[List[float]]) -> float:
   
    return FIXED_TAXI_COST + COST_PER_KM * route_distance(route, dist)


def decode_giant_tour_min_cost_dp(
    chromosome: List[int],
    dist: List[List[float]],
    capacity: int = TAXI_CAPACITY
) -> Tuple[List[List[int]], float]:
   
    n = len(chromosome)
    INF = 1e30

    
    dp = [INF] * (n + 1)
    prev = [-1] * (n + 1)  
    dp[0] = 0.0

    
    for i in range(n):
        if dp[i] >= INF:
            continue
        
        for L in range(1, capacity + 1):
            j = i + L
            if j > n:
                break
            route = chromosome[i:j]  
            c = segment_route_cost(route, dist)
            if dp[i] + c < dp[j]:
                dp[j] = dp[i] + c
                prev[j] = i

    if prev[n] == -1 and n > 0:
        raise RuntimeError("Decode failed: no feasible split found (should not happen with capacity>=1).")

    
    routes: List[List[int]] = []
    cur = n
    while cur > 0:
        i = prev[cur]
        if i < 0:
            raise RuntimeError("Backtracking failed in decode.")
        routes.append(chromosome[i:cur])
        cur = i
    routes.reverse()

    return routes, dp[n]


def evaluate_individual_vrp(
    ind: "Individual",
    dist: List[List[float]],
    time: List[List[float]]
) -> None:
 
    routes, total_cost = decode_giant_tour_min_cost_dp(ind.chromosome, dist, capacity=TAXI_CAPACITY)

    durations = [route_duration(r, time) for r in routes]
    if not durations:  
        max_dur = 0.0
        avg_dur = 0.0
    else:
        max_dur = max(durations)
        avg_dur = sum(durations) / len(durations)

    ind.f1_total_cost = total_cost
    ind.f2_max_route_duration = max_dur
    ind.f3_avg_route_duration = avg_dur


def evaluate_population_vrp(
    pop: List["Individual"],
    dist: List[List[float]],
    time: List[List[float]]
) -> None:
    for ind in pop:
        evaluate_individual_vrp(ind, dist, time)

        

if __name__ == "__main__":
 
    distance_matrix =  [
    [
      0.0,
      12.553,
      15.84,
      22.841,
      13.059,
      15.872,
      27.783,
      25.493,
      25.966,
      16.144,
      17.519,
      15.991,
      10.084,
      16.655,
      18.576,
      21.969,
      14.73,
      17.475,
      22.76,
      21.8,
      15.786,
      4.594,
      11.627,
      18.149,
      11.876,
      12.714,
      19.006,
      18.661,
      14.62,
      19.002
    ],
    [
      11.972,
      0.0,
      4.861,
      28.722,
      10.547,
      10.226,
      19.472,
      16.561,
      29.832,
      12.22,
      5.034,
      5.137,
      14.243,
      3.438,
      10.265,
      13.027,
      18.596,
      9.163,
      13.828,
      12.868,
      4.034,
      8.756,
      0.536,
      7.338,
      1.234,
      12.288,
      13.386,
      12.431,
      18.486,
      24.799
    ],
    [
      15.728,
      4.897,
      0.0,
      29.95,
      11.77,
      9.609,
      17.237,
      11.68,
      31.06,
      12.619,
      3.409,
      0.277,
      15.471,
      2.546,
      7.793,
      9.018,
      19.824,
      6.92,
      8.947,
      7.987,
      3.583,
      13.101,
      4.979,
      3.301,
      7.748,
      13.51,
      13.311,
      12.357,
      19.714,
      26.684
    ],
    [
      23.013,
      28.87,
      29.703,
      0.0,
      21.269,
      25.829,
      35.28,
      44.239,
      4.443,
      32.153,
      31.382,
      29.855,
      15.686,
      30.519,
      29.639,
      33.032,
      12.448,
      28.537,
      33.822,
      32.862,
      31.555,
      23.443,
      28.499,
      32.013,
      28.783,
      18.191,
      32.336,
      34.522,
      11.982,
      6.141
    ],
    [
      13.771,
      10.93,
      11.762,
      21.767,
      0.0,
      4.396,
      14.439,
      23.397,
      22.877,
      3.084,
      13.441,
      11.914,
      7.288,
      12.578,
      9.256,
      13.937,
      9.689,
      8.155,
      15.257,
      14.296,
      13.614,
      10.549,
      10.559,
      14.072,
      10.843,
      2.419,
      6.35,
      7.079,
      11.531,
      20.217
    ],
    [
      14.903,
      10.381,
      9.903,
      25.345,
      4.417,
      0.0,
      14.231,
      14.294,
      26.455,
      4.753,
      12.671,
      10.055,
      10.866,
      10.973,
      5.025,
      9.705,
      15.219,
      3.923,
      11.561,
      10.601,
      15.263,
      11.452,
      10.01,
      12.722,
      10.294,
      8.491,
      3.604,
      3.601,
      15.109,
      23.795
    ],
    [
      24.908,
      19.299,
      17.297,
      34.821,
      18.575,
      13.494,
      0.0,
      14.03,
      31.542,
      12.907,
      17.546,
      16.795,
      22.13,
      18.068,
      11.332,
      12.986,
      26.483,
      12.483,
      13.174,
      12.759,
      20.138,
      21.457,
      18.928,
      17.597,
      19.212,
      20.316,
      8.827,
      8.512,
      26.373,
      37.072
    ],
    [
      24.465,
      16.936,
      11.454,
      44.245,
      18.132,
      13.884,
      13.973,
      0.0,
      40.966,
      17.713,
      11.703,
      10.952,
      21.687,
      12.224,
      8.207,
      4.709,
      26.04,
      9.304,
      3.376,
      4.324,
      14.295,
      21.014,
      16.673,
      11.753,
      16.837,
      19.873,
      14.634,
      13.577,
      25.93,
      46.496
    ],
    [
      23.944,
      29.429,
      30.262,
      4.433,
      21.828,
      31.286,
      31.421,
      40.379,
      0.0,
      28.293,
      31.941,
      30.414,
      16.502,
      31.078,
      30.198,
      40.037,
      12.63,
      29.096,
      41.365,
      42.311,
      32.114,
      25.369,
      29.058,
      32.572,
      29.342,
      17.447,
      28.477,
      30.663,
      12.841,
      10.488
    ],
    [
      15.648,
      12.425,
      12.555,
      23.643,
      3.3,
      4.729,
      12.603,
      21.561,
      25.74,
      0.0,
      14.234,
      12.706,
      7.878,
      13.37,
      9.447,
      14.128,
      10.344,
      8.346,
      15.448,
      14.488,
      14.407,
      13.249,
      12.053,
      16.608,
      12.338,
      3.571,
      5.563,
      6.499,
      10.928,
      22.093
    ],
    [
      17.272,
      4.689,
      2.281,
      31.494,
      13.314,
      13.808,
      21.5,
      13.116,
      32.605,
      14.164,
      0.0,
      2.438,
      17.016,
      1.642,
      10.803,
      10.453,
      21.369,
      11.118,
      10.383,
      9.423,
      1.756,
      14.645,
      4.772,
      2.781,
      5.831,
      15.055,
      17.51,
      16.556,
      21.258,
      28.229
    ],
    [
      15.879,
      5.174,
      0.277,
      30.101,
      11.921,
      9.76,
      17.388,
      11.251,
      31.211,
      12.77,
      2.814,
      0.0,
      15.622,
      2.823,
      7.944,
      8.589,
      19.975,
      7.071,
      8.518,
      7.558,
      3.859,
      13.252,
      5.256,
      2.872,
      7.899,
      13.661,
      13.462,
      12.508,
      19.865,
      26.835
    ],
    [
      9.281,
      14.969,
      15.802,
      15.811,
      6.324,
      11.927,
      19.785,
      22.654,
      17.58,
      8.099,
      17.48,
      15.953,
      0.0,
      16.617,
      15.737,
      19.13,
      5.462,
      14.636,
      19.921,
      18.961,
      17.654,
      9.213,
      14.597,
      18.111,
      14.881,
      5.245,
      12.674,
      14.452,
      5.124,
      14.92
    ],
    [
      16.458,
      3.476,
      2.417,
      30.68,
      12.499,
      10.743,
      20.805,
      14.094,
      31.79,
      13.349,
      1.594,
      2.694,
      16.201,
      0.0,
      10.207,
      11.431,
      20.554,
      10.496,
      11.361,
      10.4,
      1.192,
      13.831,
      3.558,
      4.495,
      4.617,
      14.24,
      13.976,
      12.948,
      20.444,
      27.414
    ],
    [
      17.021,
      10.275,
      7.483,
      28.722,
      10.688,
      5.608,
      10.681,
      8.257,
      29.832,
      10.269,
      10.227,
      7.634,
      14.243,
      10.748,
      0.0,
      4.915,
      18.597,
      1.298,
      5.102,
      4.687,
      12.818,
      13.571,
      11.041,
      10.277,
      11.325,
      12.429,
      6.629,
      5.571,
      18.486,
      27.172
    ],
    [
      20.899,
      14.154,
      8.672,
      32.6,
      14.566,
      10.318,
      13.493,
      4.734,
      43.387,
      14.146,
      8.921,
      8.169,
      18.121,
      9.442,
      4.845,
      0.0,
      22.474,
      5.941,
      1.58,
      1.538,
      11.512,
      17.448,
      13.891,
      8.971,
      14.055,
      16.306,
      11.272,
      10.214,
      22.363,
      31.05
    ],
    [
      12.92,
      18.405,
      19.238,
      12.768,
      9.189,
      15.364,
      21.514,
      30.473,
      12.412,
      10.02,
      20.917,
      19.39,
      3.847,
      20.054,
      19.174,
      22.567,
      0.0,
      18.072,
      23.358,
      22.397,
      21.09,
      14.345,
      18.034,
      21.548,
      18.318,
      6.782,
      15.539,
      17.889,
      1.343,
      12.071
    ],
    [
      16.66,
      9.719,
      6.926,
      28.361,
      10.327,
      5.247,
      10.597,
      9.413,
      29.471,
      9.908,
      9.671,
      7.077,
      13.883,
      10.192,
      1.39,
      6.071,
      18.236,
      0.0,
      6.258,
      5.843,
      12.262,
      13.21,
      9.455,
      9.721,
      9.62,
      12.068,
      6.268,
      5.21,
      18.125,
      26.811
    ],
    [
      21.502,
      13.973,
      8.491,
      33.203,
      15.168,
      10.921,
      13.612,
      3.759,
      42.412,
      14.749,
      8.74,
      7.988,
      18.724,
      9.261,
      4.964,
      1.466,
      23.077,
      6.06,
      0.0,
      1.636,
      11.331,
      18.051,
      13.71,
      8.79,
      13.874,
      16.909,
      11.391,
      10.333,
      22.966,
      31.653
    ],
    [
      20.422,
      12.893,
      7.41,
      32.123,
      14.089,
      9.841,
      13.313,
      4.244,
      33.233,
      13.669,
      7.66,
      6.908,
      17.644,
      8.181,
      4.664,
      1.538,
      21.997,
      7.151,
      1.511,
      0.0,
      10.251,
      16.971,
      12.63,
      7.71,
      12.794,
      15.829,
      11.091,
      12.588,
      21.887,
      30.573
    ],
    [
      17.033,
      4.077,
      3.163,
      31.836,
      13.655,
      15.089,
      22.782,
      14.397,
      32.946,
      14.505,
      1.759,
      3.439,
      17.357,
      1.192,
      12.084,
      11.735,
      21.71,
      12.4,
      11.664,
      10.704,
      0.0,
      13.818,
      4.159,
      4.062,
      5.218,
      15.396,
      18.791,
      17.837,
      21.6,
      28.57
    ],
    [
      4.705,
      8.782,
      12.069,
      24.241,
      10.329,
      12.031,
      23.942,
      21.652,
      25.351,
      13.037,
      13.748,
      12.22,
      9.469,
      12.884,
      14.735,
      18.128,
      14.115,
      13.633,
      18.919,
      17.959,
      12.015,
      0.0,
      7.856,
      14.378,
      8.104,
      10.829,
      15.165,
      14.82,
      14.004,
      19.723
    ],
    [
      12.841,
      0.536,
      4.985,
      28.311,
      10.136,
      9.815,
      19.061,
      16.151,
      29.421,
      11.809,
      5.159,
      7.075,
      13.832,
      3.562,
      9.854,
      12.616,
      18.185,
      8.752,
      13.418,
      12.458,
      4.159,
      9.625,
      0.0,
      9.233,
      1.06,
      11.877,
      12.975,
      12.021,
      18.075,
      24.388
    ],
    [
      18.019,
      7.261,
      3.396,
      34.388,
      16.354,
      12.106,
      19.798,
      11.414,
      35.498,
      15.935,
      2.51,
      2.894,
      19.91,
      4.376,
      9.101,
      8.752,
      24.263,
      9.417,
      8.681,
      7.721,
      3.943,
      15.392,
      7.343,
      0.0,
      10.039,
      18.095,
      15.808,
      14.854,
      24.152,
      28.975
    ],
    [
      12.07,
      1.5,
      6.373,
      29.828,
      11.653,
      11.332,
      20.578,
      17.668,
      30.938,
      13.326,
      6.547,
      8.592,
      15.349,
      4.95,
      11.371,
      14.133,
      19.703,
      10.27,
      14.935,
      13.975,
      5.547,
      8.855,
      1.827,
      10.75,
      0.0,
      13.394,
      14.492,
      13.538,
      19.592,
      25.905
    ],
    [
      12.293,
      12.881,
      13.713,
      18.267,
      2.446,
      6.962,
      17.325,
      26.284,
      17.932,
      3.565,
      15.392,
      13.864,
      5.013,
      14.528,
      14.171,
      17.564,
      7.054,
      13.069,
      18.354,
      17.394,
      15.565,
      10.545,
      12.509,
      16.022,
      12.793,
      0.0,
      8.672,
      9.608,
      7.639,
      19.541
    ],
    [
      18.612,
      13.653,
      13.601,
      32.98,
      6.542,
      3.598,
      8.686,
      17.857,
      29.701,
      5.538,
      16.369,
      13.752,
      13.547,
      14.599,
      6.71,
      11.391,
      17.9,
      7.001,
      11.579,
      11.163,
      18.961,
      15.161,
      13.282,
      16.42,
      13.566,
      8.817,
      0.0,
      1.139,
      17.789,
      26.476
    ],
    [
      17.862,
      12.889,
      12.852,
      28.028,
      7.073,
      3.508,
      8.332,
      17.503,
      32.36,
      6.501,
      15.62,
      13.003,
      13.549,
      13.849,
      5.961,
      10.641,
      17.902,
      6.073,
      10.829,
      10.414,
      18.211,
      14.412,
      12.518,
      15.67,
      12.802,
      9.643,
      1.166,
      0.0,
      17.792,
      26.478
    ],
    [
      13.652,
      19.137,
      19.97,
      11.884,
      11.536,
      16.095,
      22.722,
      26.822,
      13.263,
      11.228,
      21.649,
      20.121,
      4.996,
      20.786,
      19.906,
      23.299,
      1.208,
      18.804,
      24.089,
      23.129,
      21.822,
      15.077,
      18.766,
      22.279,
      19.05,
      7.99,
      18.624,
      18.621,
      0.0,
      10.812
    ],
    [
      18.916,
      25.822,
      26.663,
      5.87,
      20.498,
      25.057,
      35.92,
      44.879,
      10.916,
      32.793,
      28.342,
      26.814,
      15.172,
      27.479,
      26.866,
      30.259,
      12.21,
      25.765,
      31.05,
      30.09,
      28.515,
      19.346,
      24.739,
      28.973,
      25.023,
      20.06,
      32.976,
      35.163,
      11.747,
      0.0
    ]
  ]



    time_matrix =  [
    [
      0.0,
      17.167,
      19.602,
      27.207,
      16.72,
      19.61,
      27.867,
      27.72,
      27.79,
      20.712,
      22.392,
      20.248,
      13.683,
      21.718,
      20.237,
      25.04,
      18.167,
      18.845,
      24.337,
      23.405,
      23.405,
      8.315,
      16.502,
      22.627,
      15.757,
      16.563,
      23.05,
      21.765,
      18.11,
      22.935
    ],
    [
      16.285,
      0.0,
      7.508,
      27.08,
      12.195,
      12.44,
      18.855,
      18.547,
      27.542,
      14.333,
      8.002,
      8.338,
      13.765,
      6.058,
      11.225,
      15.362,
      17.918,
      9.833,
      15.163,
      14.232,
      6.967,
      11.823,
      1.362,
      10.883,
      2.695,
      13.9,
      15.518,
      14.132,
      17.862,
      25.178
    ],
    [
      17.833,
      7.555,
      0.0,
      27.29,
      12.083,
      11.363,
      17.623,
      12.868,
      27.752,
      13.652,
      4.105,
      0.83,
      13.975,
      3.432,
      8.767,
      10.787,
      18.128,
      8.587,
      9.485,
      8.553,
      5.365,
      13.243,
      7.407,
      4.202,
      8.303,
      13.788,
      14.623,
      13.237,
      18.072,
      25.518
    ],
    [
      25.577,
      28.812,
      27.657,
      0.0,
      21.278,
      26.103,
      28.718,
      31.295,
      5.72,
      25.15,
      30.447,
      28.303,
      16.813,
      29.773,
      27.117,
      31.92,
      13.865,
      25.725,
      31.217,
      30.285,
      31.707,
      24.062,
      27.927,
      30.682,
      27.517,
      21.397,
      26.215,
      26.243,
      13.725,
      7.358
    ],
    [
      16.098,
      13.943,
      12.488,
      21.25,
      0.0,
      7.367,
      17.383,
      19.96,
      21.712,
      3.992,
      15.278,
      13.135,
      7.935,
      14.605,
      11.205,
      17.055,
      11.64,
      9.813,
      16.615,
      15.683,
      16.538,
      11.073,
      13.058,
      15.513,
      12.648,
      4.523,
      8.422,
      9.427,
      12.032,
      20.165
    ],
    [
      17.335,
      13.557,
      11.273,
      24.343,
      7.65,
      0.0,
      14.295,
      15.602,
      24.805,
      6.95,
      13.052,
      11.92,
      11.028,
      13.703,
      6.665,
      12.515,
      15.182,
      5.273,
      12.218,
      11.287,
      15.345,
      11.802,
      12.672,
      11.942,
      12.262,
      10.923,
      5.652,
      5.018,
      15.125,
      23.258
    ],
    [
      24.733,
      19.827,
      17.878,
      28.285,
      17.447,
      13.497,
      0.0,
      13.838,
      24.58,
      15.628,
      19.477,
      18.408,
      19.003,
      20.49,
      11.127,
      13.888,
      23.157,
      11.183,
      14.377,
      14.01,
      21.77,
      19.2,
      18.942,
      18.367,
      18.532,
      19.152,
      12.462,
      11.932,
      23.1,
      28.193
    ],
    [
      26.138,
      19.148,
      12.065,
      31.918,
      18.852,
      15.73,
      14.223,
      0.0,
      28.213,
      18.955,
      13.663,
      12.595,
      20.408,
      14.677,
      10.067,
      5.888,
      24.562,
      12.002,
      4.302,
      5.957,
      15.957,
      20.605,
      18.682,
      12.553,
      18.353,
      20.557,
      17.89,
      16.757,
      24.505,
      31.827
    ],
    [
      25.455,
      28.597,
      27.442,
      5.993,
      21.063,
      25.465,
      25.198,
      27.775,
      0.0,
      21.63,
      30.232,
      28.088,
      16.692,
      29.558,
      26.902,
      30.01,
      12.768,
      25.51,
      28.54,
      29.578,
      31.492,
      23.855,
      27.712,
      30.467,
      27.302,
      19.172,
      22.695,
      22.723,
      12.99,
      10.002
    ],
    [
      19.58,
      15.642,
      13.595,
      24.732,
      4.482,
      7.008,
      15.31,
      17.887,
      21.862,
      0.0,
      16.385,
      14.242,
      10.64,
      15.712,
      10.828,
      16.678,
      13.857,
      9.437,
      16.238,
      15.307,
      17.645,
      14.275,
      14.757,
      15.962,
      14.347,
      5.348,
      7.35,
      8.708,
      14.348,
      23.647
    ],
    [
      20.237,
      8.215,
      3.593,
      29.693,
      14.487,
      14.12,
      20.355,
      14.478,
      30.155,
      16.055,
      0.0,
      4.168,
      16.378,
      3.015,
      11.15,
      12.397,
      20.532,
      11.343,
      11.095,
      10.163,
      3.117,
      15.647,
      8.067,
      4.297,
      10.432,
      16.192,
      17.38,
      15.993,
      20.475,
      27.922
    ],
    [
      18.512,
      8.342,
      0.787,
      27.968,
      12.762,
      12.042,
      18.302,
      13.392,
      28.43,
      14.33,
      4.752,
      0.0,
      14.653,
      4.218,
      9.445,
      11.31,
      18.807,
      9.265,
      10.008,
      9.077,
      6.152,
      13.922,
      8.193,
      4.725,
      8.982,
      14.467,
      15.302,
      13.915,
      18.75,
      26.197
    ],
    [
      12.203,
      16.208,
      15.053,
      15.968,
      7.417,
      13.5,
      21.053,
      21.997,
      16.842,
      10.845,
      17.843,
      15.7,
      0.0,
      17.17,
      14.513,
      19.317,
      6.163,
      13.122,
      18.613,
      17.682,
      19.103,
      10.77,
      15.323,
      18.078,
      14.913,
      6.643,
      15.838,
      15.595,
      6.132,
      15.295
    ],
    [
      19.873,
      5.888,
      3.383,
      29.33,
      14.123,
      14.223,
      20.733,
      16.175,
      29.792,
      15.692,
      2.863,
      4.213,
      16.015,
      0.0,
      12.073,
      14.093,
      20.168,
      11.712,
      12.792,
      11.86,
      2.183,
      15.283,
      5.74,
      6.1,
      8.105,
      15.828,
      17.092,
      15.915,
      20.112,
      27.558
    ],
    [
      18.29,
      13.062,
      9.205,
      25.875,
      11.003,
      7.053,
      10.315,
      10.16,
      26.337,
      11.107,
      11.023,
      9.852,
      12.56,
      12.037,
      0.0,
      6.285,
      16.713,
      2.268,
      6.773,
      6.407,
      13.317,
      12.757,
      12.498,
      9.913,
      12.088,
      12.708,
      8.157,
      7.023,
      16.657,
      24.79
    ],
    [
      23.005,
      16.168,
      9.085,
      30.59,
      15.718,
      12.597,
      14.302,
      6.07,
      30.872,
      15.822,
      10.683,
      9.615,
      17.275,
      11.697,
      6.195,
      0.0,
      21.428,
      8.13,
      2.683,
      2.562,
      12.977,
      17.472,
      15.702,
      9.573,
      15.373,
      17.423,
      14.018,
      12.885,
      21.372,
      29.505
    ],
    [
      16.608,
      19.75,
      18.595,
      13.312,
      10.82,
      17.042,
      22.845,
      25.422,
      12.577,
      12.747,
      21.385,
      19.242,
      5.947,
      20.712,
      18.055,
      22.858,
      0.0,
      16.663,
      22.155,
      21.223,
      22.645,
      15.008,
      18.865,
      21.62,
      18.455,
      8.717,
      19.242,
      19.137,
      1.877,
      13.262
    ],
    [
      18.095,
      12.545,
      8.688,
      25.68,
      10.808,
      6.858,
      9.782,
      11.877,
      26.142,
      10.912,
      10.507,
      9.335,
      12.365,
      11.52,
      2.152,
      8.002,
      16.518,
      0.0,
      8.49,
      8.123,
      12.8,
      12.562,
      12.078,
      9.397,
      11.75,
      12.513,
      7.962,
      6.828,
      16.462,
      24.595
    ],
    [
      22.9,
      15.91,
      8.827,
      30.485,
      15.613,
      12.492,
      14.257,
      4.928,
      29.73,
      15.717,
      10.425,
      9.357,
      17.17,
      11.438,
      6.15,
      1.972,
      21.323,
      8.085,
      0.0,
      2.582,
      12.718,
      17.367,
      15.443,
      9.315,
      15.115,
      17.318,
      13.973,
      12.84,
      21.267,
      29.4
    ],
    [
      21.382,
      14.392,
      7.308,
      28.967,
      14.095,
      10.973,
      14.512,
      6.025,
      29.428,
      14.198,
      8.907,
      7.838,
      15.652,
      9.92,
      6.405,
      2.462,
      19.805,
      8.197,
      2.642,
      0.0,
      11.2,
      15.848,
      13.925,
      7.797,
      13.597,
      15.8,
      14.228,
      12.847,
      19.748,
      27.882
    ],
    [
      21.75,
      7.2,
      5.385,
      31.403,
      16.197,
      15.653,
      21.888,
      16.012,
      31.865,
      17.765,
      2.948,
      6.215,
      18.088,
      2.238,
      12.683,
      13.93,
      22.242,
      12.877,
      12.628,
      11.697,
      0.0,
      17.288,
      7.052,
      5.83,
      9.417,
      17.902,
      18.913,
      17.527,
      22.185,
      29.632
    ],
    [
      8.673,
      10.915,
      13.35,
      23.928,
      11.088,
      13.482,
      21.738,
      21.592,
      24.39,
      15.035,
      16.14,
      13.997,
      10.283,
      15.467,
      14.108,
      18.912,
      14.767,
      12.717,
      18.208,
      17.277,
      17.153,
      0.0,
      10.25,
      16.375,
      9.505,
      11.725,
      16.922,
      15.637,
      14.71,
      19.953
    ],
    [
      15.888,
      1.46,
      7.445,
      26.485,
      11.6,
      11.845,
      18.26,
      17.952,
      26.947,
      13.738,
      7.938,
      8.142,
      13.17,
      5.995,
      10.63,
      14.767,
      17.323,
      9.238,
      14.568,
      13.637,
      6.903,
      11.427,
      0.0,
      10.52,
      2.365,
      13.305,
      14.923,
      13.537,
      17.267,
      24.583
    ],
    [
      20.868,
      10.81,
      4.315,
      29.642,
      14.77,
      11.648,
      17.883,
      12.007,
      30.103,
      14.873,
      3.418,
      4.845,
      16.327,
      5.848,
      8.678,
      9.925,
      20.48,
      8.872,
      8.623,
      7.692,
      5.59,
      16.278,
      10.662,
      0.0,
      11.338,
      16.475,
      14.908,
      13.522,
      20.423,
      28.553
    ],
    [
      16.02,
      2.595,
      9.008,
      28.093,
      13.208,
      13.453,
      19.868,
      19.56,
      28.555,
      15.347,
      9.502,
      9.75,
      14.778,
      7.558,
      12.238,
      16.375,
      18.932,
      10.847,
      16.177,
      15.245,
      8.467,
      11.558,
      2.945,
      12.128,
      0.0,
      14.913,
      16.532,
      15.145,
      18.875,
      26.192
    ],
    [
      15.928,
      15.782,
      14.327,
      20.562,
      4.28,
      11.118,
      18.322,
      20.898,
      19.43,
      5.267,
      17.117,
      14.973,
      6.743,
      16.443,
      14.4,
      19.203,
      9.465,
      13.008,
      18.5,
      17.568,
      18.377,
      11.198,
      14.897,
      17.352,
      14.487,
      0.0,
      11.673,
      13.032,
      9.957,
      20.073
    ],
    [
      20.852,
      16.757,
      14.477,
      26.86,
      8.818,
      5.763,
      12.408,
      15.832,
      23.155,
      7.262,
      16.255,
      15.123,
      14.455,
      16.827,
      8.253,
      14.103,
      18.608,
      8.118,
      14.592,
      14.225,
      18.548,
      15.318,
      15.872,
      15.145,
      15.462,
      11.75,
      0.0,
      2.335,
      18.552,
      26.685
    ],
    [
      19.817,
      15.627,
      13.442,
      27.058,
      9.592,
      4.983,
      11.775,
      15.198,
      24.178,
      8.702,
      15.22,
      14.088,
      13.743,
      15.792,
      7.218,
      13.068,
      17.897,
      6.858,
      13.557,
      13.19,
      17.513,
      14.283,
      14.742,
      14.11,
      14.332,
      13.09,
      2.455,
      0.0,
      17.84,
      25.973
    ],
    [
      15.8,
      18.942,
      17.787,
      12.308,
      11.408,
      16.233,
      24.81,
      24.73,
      13.237,
      14.712,
      20.577,
      18.433,
      6.152,
      19.903,
      17.247,
      22.05,
      1.965,
      15.855,
      21.347,
      20.415,
      21.837,
      14.2,
      18.057,
      20.812,
      17.647,
      10.682,
      18.962,
      18.328,
      0.0,
      11.658
    ],
    [
      21.658,
      26.163,
      25.542,
      7.698,
      20.388,
      25.213,
      26.973,
      29.55,
      10.068,
      23.405,
      28.332,
      26.188,
      16.017,
      27.658,
      26.18,
      30.983,
      13.033,
      24.788,
      30.28,
      29.348,
      29.592,
      20.143,
      25.4,
      28.567,
      24.99,
      20.932,
      24.47,
      24.498,
      13.36,
      0.0
    ]
  
  ]



    
    n_customers = len(distance_matrix) - 1

    pop_size = 60
    generations = 10000
    seed = 0

    rng = random.Random(seed)

    
    P = init_population(pop_size, n_customers, seed=seed)

    
    evaluate_population_vrp(P, distance_matrix, time_matrix)
    apply_duplicate_penalty(P, penalty_step=12.0)
    

    BASE_MUT = 0.05
    BOOST_MUT = 0.60
    for gen in range(generations):
        prepare_rank_and_crowding(P)
              
        mut_rate = BASE_MUT
        if all(ind.rank == 1 for ind in P):
            mut_rate = BOOST_MUT

        mating_pool = build_mating_pool(P, pool_size=pop_size, seed=seed + 2000 + gen)

        Q = make_offspring(
            parents=mating_pool,
            rng=rng,
            crossover_rate=0.90,
            mutation_rate=mut_rate,

            mutation_kind="inversion"
        )

        evaluate_population_vrp(Q, distance_matrix, time_matrix)
        apply_duplicate_penalty(Q, penalty_step= 12.0)
        P = environmental_selection_elitist(P, Q, pop_size)

        if (gen + 1) % 1 == 0:
            rank1_count = sum(1 for x in P if x.rank == 1)
            ranks = sorted(set(x.rank for x in P))
            print(f"Gen {gen+1:4d} | rank1 count: {rank1_count} | ranks present: {ranks[:10]}")

    
    prepare_rank_and_crowding(P)
    f1 = [x for x in P if x.rank == 1]
    print("\nFinal Rank-1 solutions:", len(f1))
    prepare_rank_and_crowding(P)
    f1 = [x for x in P if x.rank == 1]
    print("\nFinal Rank-1 solutions:", len(f1))

    seen = set()
    shown = 0

    for i, ind in enumerate(sorted(f1, key=lambda z: (z.f1_total_cost, z.f2_max_route_duration, z.f3_avg_route_duration)), 1):
        routes, total_cost = decode_giant_tour_min_cost_dp(ind.chromosome, distance_matrix, capacity=TAXI_CAPACITY)

        
        key = tuple(tuple(r) for r in routes)
        if key in seen:
            continue
        seen.add(key)

        durations = [route_duration(r, time_matrix) for r in routes]
        max_dur = max(durations) if durations else 0.0
        avg_dur = (sum(durations) / len(durations)) if durations else 0.0

        print(f"\n{i:2d}) f1(cost)={total_cost:.2f} | f2(maxT)={max_dur:.2f} | f3(avgT)={avg_dur:.2f}")
        print("    chromosome:", ind.chromosome)
        print("    routes:")
        for k, r in enumerate(routes, 1):
            print(f"      taxi{k}: [0] -> {r} -> [0]   (T={route_duration(r, time_matrix):.2f})")

        shown += 1
        if shown >= 15:
            break
